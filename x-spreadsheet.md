# 如何用canvas构建一个表格编辑器

## 区域划分

- 内容区
- 行列标题区
- 滚动区
- 操作区

## 内容区

内容区功能：

- 展示表格内容
- 存储选中状态和光标状态
- 允许录入内容，允许右键菜单
- 可以选中多个单元格
- 冻结行列

数据存储格式

见data_proxy.js

各部分的渲染机制：

表格内容、冻结行列：通过在画布上移动原点和各种绘制画出整个表格，不是很好懂。

data_proxy记录了合并单元格、行高等所有数据，可以计算出可视区域应该展示的行列。

选中多个单元格、双击选中单个单元格、拖拽改变行高列宽等，都是通过监听canvas上层蒙板的mouse事件实现的。通过响应用户操作，在canvas层上方遮照了各种不同的html元素。

## 行列标题区

可拖拽设置列宽，行高。

也属于内容区相同的处理思路。

## 滚动区

- 可以根据表格大小正确设置滚动条
- 滚动之后控制表格内容区展现对应的内容

滚动条是侧边和底部的原生组件。

滚动条滚动之后，根据滚动位置计算滚动区域、重算悬浮html元素位置（编辑器，选中框）

## 操作区

各个操作按钮可以控制和修改表格内容。

# 改造方案

## 梳理整体架构，各部分的关联机制

## 改造为可扩展体系

### 分层

#### UI层

编辑器层提供一个可以展现表格内容、行列滚动条的编辑器，同时提供变更编辑器状态的各种方法。

编辑器的输入框组件可定制，提供一个编辑框规范。

编辑器的选中状态、滚动等引起状态变更的事件可对外抛出。

编辑器提供一个抽象的文档对象，任何实现此接口的文档对象都可以实现文档渲染。

单元格内容，需要提供一种自定义渲染机制，以供在表格中渲染。

支持列的隐藏展示。

支持头、行列头的自定义渲染，将渲染的必要信息传给外部渲染函数。

鼠标悬浮和点击事件，允许行头列头自定义处理机制。

自动填充事件抛出。

粘贴事件抛出。

右键菜单事件。

#### 编辑器层

提供一个节省内存的默认文档对象实现，支持图片、文本、公式、提示。

提供一个编辑框实现，支持公式录入。

提供一个顶部编辑框，在单选单元格未双击时，显示并编辑录入内容，支持公式录入。

提供默认的行头，列头，允许拖拽设置行高、列宽。允许设置组合列。

提供一个工具栏，可以设置单元格格式、边框、冻结行列。

提供一个底部可切换sheet的切换sheet页实现。

实现自动填充。

实现粘贴处理。

实现右键菜单。

## 需要扩展的展现特性

- 可换行文本支持
- 富文本支持，包括图片、链接、提示、@、点击事件等

# roadmap

- [x] 实现渲染框架基本结构，绘制静态表格线。
- [x] 添加横竖滚动条。
- [x] 为表格内容提供展现机制。单元格内容通过clipPath方法，截取单元格内可以显示的部分。内容的渲染在边框线之前，以便边框线不被内容覆盖。
- [x] 添加表格行头、列头。
- [x] fabric.js的渲染机制太慢了，重写一个简洁的渲染库，兼容fabric语法
- [ ] 添加事件监听机制，添加选中框效果。
- [ ] 实现一个可resize的行头，列头。
- [ ] 添加双击调起输入框反馈事件。
- [ ] 实现一个简易数据结构和输入框编辑器，此时完成了一个可以编辑单元格的简易表格。
- [ ] 优化渲染数据的内部实现，将行列处理抽象成统一处理结构，将内部的处理过程在代码中拆分的更清晰。
- [ ] 梳理表格提供的核心功能，提供扩展机制。
- [ ] 添加分组特性。
- [ ] 添加自动填充支持。
- [ ] 添加粘贴支持。
- [ ] 添加右键菜单实现。
- [ ] 添加顶部工具栏实现。
- [ ] 添加公式支持。
- [ ] 添加一个格式支持能力较强的单元格编辑器，将编辑器和底层存储格式解藕。


